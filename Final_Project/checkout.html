<!doctype html>
<html lang="en">
  <head>
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />

    <title>Checkout</title>
  </head>
  <body class="bg-light mt-5 pt-5" style="min-height: 1500px">

    <div id="navbar"></div>
    <div class="container text-center">
      <div class="py-5">
        <img src="/imgs/bag-checkout.jpg" alt="" width="72px" height="72px" />
      </div>

      <h1>Checkout</h1>
      <p class="lead">
        Lorem ipsum dolor sit amet consectetur adipisicing elit.
      </p>
    </div>

    <div class="container">
      <h4>Billing Address</h4>
      <form id="checkout-form" novalidate>
        <div class="row g-3">
          <div class="col-sm-6">
            <label for="firstName" class="form-label">First Name</label>
            <input
              id="firstName"
              type="text"
              class="form-control"
              placeholder="Please enter your first name"
              required
            />
            <div class="invalid-feedback">valid first name is required</div>
          </div>

          <div class="col-sm-6">
            <label for="lastName" class="form-label">Last Name</label>
            <input
              id="lastName"
              type="text"
              class="form-control"
              placeholder="Please enter your last name"
              required
            />
            <div class="invalid-feedback">valid first name is required</div>
          </div>

          <div class="col-12">
            <label for="username" class="form-label">Email</label>
            <div class="input-group">
              <div class="span input-group-text">@</div>
              <input
                id="username"
                type="text"
                class="form-control"
                placeholder="Please enter your Email"
                required
              />
              <div class="invalid-feedback">valid username is required</div>
            </div>
          </div>

          <div class="col-md-4">
            <label for="country" class="form-label">Country</label>

            <select
              id="country"
              class="form-control"
              placeholder="Please enter your username"
              required
            >
              <option>Choose...</option>
              <option class="Australia">Australia</option>
              <option class="Egypt">Egypt</option>
              <option class="Morocco">Morocco</option>
              <option class="Greek">Greek</option>
              <option class="China">China</option>
            </select>

            <div class="invalid-feedback">valid username is required</div>
          </div>

          <div class="col-md-4">
            <label for="State" class="form-label">State</label>

            <select
              id="state"
              class="form-control"
              placeholder="Please enter your username"
              required
            >
              <option>Choose...</option>
              <option class="Australia">WA</option>
              <option class="Egypt">SA</option>
              <option class="Morocco">Cairo</option>
              <option class="Greek">Alex</option>
              <option class="China">NT</option>
            </select>

            <div class="invalid-feedback">valid username is required</div>
          </div>

          <div class="col-md-3">
            <label for="Postcode" class="form-label">Postcode</label>
            <input
              id="Postcode"
              type="number"
              class="form-control"
              placeholder="12345"
              required
            />
            <div class="invalid-feedback">valid username is required</div>
          </div>

          <hr class="my-4" />

          <div class="col-12">
            <div class="form-check">
              <input
                id="sameAddress"
                type="checkbox"
                class="form-check-input"
              />
              <label for="sameAddress" class="form-check-label"
                >Shipping address is the same as my billing address</label
              >
            </div>

            <div class="form-check">
              <input id="saveInfo" type="checkbox" class="form-check-input" />
              <label for="saveInfo" class="form-check-label"
                >Save this info</label
              >
            </div>
            <hr class="my-4" />
            <h4 class="mb-3">Payments</h4>
            <div class="form-check">
              <input
                id="creditCard"
                name="paymentMethod"
                type="radio"
                class="form-check-input"
                checked
                required
              />
              <label for="creditCard">Credit Card</label>
            </div>
            <div class="form-check">
              <input
                id="directDebit"
                name="paymentMethod"
                type="radio"
                class="form-check-input"
                checked
                required
              />
              <label for="directDebit">Direct Debit</label>
            </div>
            <div class="form-check">
              <input
                id="payPal"
                name="paymentMethod"
                type="radio"
                class="form-check-input"
                checked
                required
              />
              <label for="payPal">PayPal</label>
            </div>
          </div>

          <div class="row my-3 gy-3">
            <div class="col-md-6">
              <label for="fullName" class="form-label">Full Name on Card</label>
              <input id="fullName" type="text" class="form-control" required />
              <small class="text-muted">Full name as displayed on card</small>
              <div class="invalid-feedback">Name on card is required</div>
            </div>
            <div class="col-md-6">
              <label for="cc-number" class="form-label"
                >Credit Card Number</label
              >
              <input id="cc-number" type="text" class="form-control" required />
              <div class="invalid-feedback">Credit Card Number is required</div>
            </div>
            <div class="col-md-3">
              <label for="cc-expire" class="form-label">Expiration</label>
              <input id="cc-expire" type="text" class="form-control" required />
              <div class="invalid-feedback">Expiration is required</div>
            </div>
            <div class="col-md-3">
              <label for="cc-cvv" class="form-label">CVV</label>
              <input id="cc-cvv" type="text" class="form-control" required />
              <div class="invalid-feedback">CVV is required</div>
            </div>
            <hr class="my-4" />
            <button class="btn btn-primary btn-lg btn-block" style="background-color:black;" >
              Confirm checkout
            </button>
          </div>
        </div>
      </form>

    </div>
          <div id="footer-container"></div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
       fetch("footer.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("footer-container").innerHTML = data;
        });
      const supabaseUrl = "https://xrslatldfiyfpszgmptb.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhyc2xhdGxkZml5ZnBzemdtcHRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MDczMDEsImV4cCI6MjA4NzA4MzMwMX0.0MI2j1h3ruY3Nbdux0RyCHFHs7S8wbnWZO92AiUkD_E";

      const { createClient } = supabase;
      const db = createClient(supabaseUrl, supabaseKey);
      const checkoutForm = document.getElementById("#checkout-form");
      document
        .querySelector("#checkout-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          //////////////////////////username VALIDATION////////////////////////////////
          const usernameRegex = /^[a-zA-Z0-9]{4,}$/;
          const usernameInput = document.getElementById("username");

          if (!usernameRegex.test(usernameInput.value.trim())) {
            usernameInput.classList.add("is-invalid");
            usernameInput.nextElementSibling.textContent =
              "Username must be at least 4 characters and only letters/numbers";
            return; // stop form submission
          } else {
            usernameInput.classList.remove("is-invalid");
          }
          // Check if username already exists in the "orders" table
          const { data: existingUser, error: fetchError } = await db
            .from("orders")
            .select("username")
            .eq("username", usernameInput.value.trim())
            .limit(1);

          if (fetchError) {
            console.error(fetchError);
            alert("Error checking username. Try again later.");
            return;
          }

          if (existingUser.length > 0) {
            usernameInput.classList.add("is-invalid");
            usernameInput.nextElementSibling.textContent =
              "Username already taken. Please choose another.";
            return; // stop submission
          }

          ////////////////////Card VALIDATION//////////////////
          const ccNumberInput = document.getElementById("cc-number");

          ccNumberInput.addEventListener("input", function () {
            let value = this.value.replace(/\D/g, ""); // remove non-digits

            // limit to 16 digits only
            value = value.substring(0, 16);

            // add space every 4 digits
            value = value.replace(/(.{4})/g, "$1 ").trim();

            this.value = value;
          });

          const cvvInput = document.getElementById("cc-cvv");

          cvvInput.addEventListener("input", function () {
            let value = this.value.replace(/\D/g, ""); // remove non-digits
            this.value = value.substring(0, 3); // max 3 digits
          });

          const nameInput = document.getElementById("fullName");

          nameInput.addEventListener("input", function () {
            this.value = this.value.replace(/[^a-zA-Z\s]/g, "");
          });

          const expireInput = document.getElementById("cc-expire");

          expireInput.addEventListener("input", function () {
            let value = this.value.replace(/\D/g, ""); // digits only

            // limit to 4 digits (DDMM)
            value = value.substring(0, 4);

            // format as DD/MM
            if (value.length > 2) {
              value = value.substring(0, 2) + "/" + value.substring(2);
            }

            this.value = value;
          });

          const orderData = {
            first_name: document.getElementById("firstName").value,
            last_name: document.getElementById("lastName").value,
            username: document.getElementById("username").value,
            country: document.getElementById("country").value,
            state: document.getElementById("state").value,
            postcode: document.getElementById("Postcode").value,
            payment_method: document.querySelector(
              'input[name="paymentMethod"]:checked',
            ).id,
          };

          const { data, error } = await db.from("orders").insert(orderData);
          if (error) {
            console.error(error);
          } else {
            console.log(data);
            alert("Order placed successfully!");
            document.getElementById("checkout-form").reset();
          }
        });


        fetch("navbar.html")
.then(res=>res.text())
.then(html=>{
document.getElementById("navbar").innerHTML=html
    updateLikesCounter(); 
})



function updateLikesCounter() {
  let favlist = JSON.parse(localStorage.getItem("favorites")) || [];
  favlist = favlist.filter(item => item && item.id);

  const counter = document.getElementById("likes-counter");
  if (counter) {
    counter.innerText = favlist.length;
  }
}
    </script>
  </body>
</html>